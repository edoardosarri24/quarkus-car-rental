apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-reserve
data:
  test.js: |
    import http from "k6/http";
    import { sleep } from "k6";

    // --- Configuration ---
    const CONFIG = {
        CAR_ID: 2,
        RESERVATION_DAYS: 1,
        get baseStartDate() {
            const date = new Date();
            date.setDate(date.getDate() + 1);
            return date;
        }
    };

    // --- k6 Options ---
    export let options = {
        vus: parseInt(__ENV.VUS),
        duration: __ENV.DURATION,
    };

    /**
     * Generates the payload for a new reservation.
     * @param {number} iteration - The global iteration number across all VUs.
     * @returns {object} The reservation payload.
     */
    function createReservationPayload(iteration) {
        const startDate = new Date(CONFIG.baseStartDate);
        startDate.setDate(startDate.getDate() + iteration);

        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + CONFIG.RESERVATION_DAYS);

        return {
            startDate: startDate.toISOString().split("T")[0],
            endDate: endDate.toISOString().split("T")[0],
            carId: CONFIG.CAR_ID,
        };
    }

    // --- Main k6 execution ---
    export default function () {
        const global_iteration = __ITER * options.vus + (__VU - 1);
        const payload = createReservationPayload(global_iteration);
        http.post(__ENV.TARGET_URL, payload);
    }